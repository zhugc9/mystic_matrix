<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>提示词中心</title>
  <style>
    /* Astro Style Clone */
    :root {
        --bg-dark: #050510;
        --accent-gold: #d4af37;
        --accent-glow: rgba(212, 175, 55, 0.6);
    }
    body {
        background-color: var(--bg-dark);
        font-family: 'Segoe UI', sans-serif;
        color: #eee;
        overflow: hidden;
    }
    #stars-canvas {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: -1; opacity: 0.6; pointer-events: none;
    }
    
    /* Astro Header */
    .topbar {
        height: 80px;
        display: flex; align-items: center; justify-content: center;
        position: relative;
    }
    .title {
        color: #d4af37; text-align: center; font-size: 2.2rem; margin: 0;
        font-family: 'Cinzel', serif; letter-spacing: 4px;
        text-shadow: 0 0 10px rgba(212,175,55,0.5);
    }
    .subtitle {
        color: rgba(255,255,255,0.6); text-align: center; 
        font-size: 0.8rem; letter-spacing: 2px;
    }
    .back-btn {
        position: absolute; left: 30px; color: rgba(255,255,255,0.6); text-decoration: none;
        letter-spacing: 1px; transition: 0.3s;
    }
    .back-btn:hover { color: #d4af37; }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px 20px;
        height: calc(100vh - 100px);
        display: flex; gap: 20px;
    }

    /* Astro Glass Card */
    .glass-card {
        background: rgba(16, 20, 43, 0.85);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 8px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 30px rgba(0,0,0,0.4);
        display: flex; flex-direction: column;
        overflow: hidden;
    }

    .sidebar { width: 280px; }
    .main-area { flex: 1; }

    .panel-header {
        padding: 15px 20px;
        border-bottom: 1px solid rgba(212,175,55,0.2);
    }
    .panel-header h2 { margin: 0; color: #d4af37; font-size: 1.1rem; letter-spacing: 1px; }

    .module-item {
        padding: 15px 20px;
        border: none;
        background: transparent;
        color: #aaa;
        width: 100%; text-align: left;
        font-size: 1rem;
        cursor: pointer;
        border-right: 3px solid transparent;
        transition: 0.2s;
    }
    .module-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .module-item.active {
        background: rgba(212, 175, 55, 0.15);
        color: #d4af37;
        border-right-color: #d4af37;
    }

    textarea {
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.3) !important;
        border: none !important;
        color: #ddd !important;
        padding: 20px; box-sizing: border-box;
        font-family: monospace; font-size: 1rem; line-height: 1.6;
        resize: none; outline: none;
    }

    .controls {
        padding: 15px 20px;
        display: flex; gap: 15px; align-items: center;
        border-top: 1px solid rgba(212,175,55,0.2);
    }
    
    .btn {
        background: rgba(0,0,0,0.6);
        border: 1px solid #d4af37;
        color: #d4af37;
        padding: 8px 24px;
        border-radius: 30px;
        cursor: pointer; transition: 0.3s;
    }
    .btn:hover { background: #d4af37; color: #000; }
  </style>
</head>
<body>
  <canvas id="stars-canvas"></canvas>

  <header class="topbar">
    <a href="../index.html" class="back-btn">← 返回大厅</a>
    <div>
      <h1 class="title">提示词中心</h1>
      <div class="subtitle">PROMPT MATRIX</div>
    </div>
  </header>

  <main class="container">
    <section class="glass-card sidebar">
      <div class="panel-header">
        <h2>系统模块</h2>
      </div>
      <div id="module-list" style="overflow-y:auto; flex:1;"></div>
    </section>

    <section class="glass-card main-area">
      <div class="panel-header" style="display:flex; justify-content:space-between;">
        <h2 id="editor-title">系统提示词</h2>
        <span id="status" style="font-size:0.8rem; color:#d4af37;"></span>
      </div>
      <div style="flex:1; position:relative;">
        <textarea id="prompt-editor" spellcheck="false"></textarea>
      </div>
      <div class="controls">
        <button class="btn" id="save-btn">保存生效</button>
        <button class="btn" id="reset-btn" style="border-style:dashed; opacity:0.7;">恢复默认</button>
      </div>
    </section>
  </main>

  <script>
    const modules = [
      { key: "tarot", label: "神秘塔罗", source: "../tarot/prompts.js" },
      { key: "iching", label: "赛博易经", source: "../iching/prompts.js" },
      { key: "palmistry", label: "智能手相", source: "../palmistry/prompts.js" },
      { key: "face", label: "智能面相", source: "../face_reading/prompts.js" },
      { key: "astro", label: "星盘实验室", source: "../astro/prompts.js" },
      { key: "history", label: "命运聚合", source: null }
    ];

    const defaultHistoryPrompt = [
      "你是赛博玄学矩阵的总分析师，负责将同一天的多模块占卜结果融合成可执行的生活策略。",
      "先提炼每条记录的核心信号（风险、机会、情绪、行动倾向），再做跨模块交叉验证，明确一致项与冲突项。",
      "输出必须包含：一、今日总运势；二、事业/财运/情感/健康四板块；三、冲突信号说明；四、24小时行动清单；五、禁忌与止损建议。",
      "每个板块都要给出优先级（高/中/低）和时间窗口（上午/下午/夜间），避免空泛结论。",
      "若结论冲突，必须说明冲突来源并给出折中策略。语言保持仪式感，但建议必须落地、可执行。"
    ].join("\n");
    const defaults = {};
    let activeKey = modules[0].key;

    const listEl = MM.$("module-list");
    const editorEl = MM.$("prompt-editor");
    const titleEl = MM.$("editor-title");
    const statusEl = MM.$("status");

    // --- Prompt Loading Mechanism ---
    // Intercept window.PROMPTS assignment to capture data from module scripts
    let currentLoadingKey = null;
    let _promptsVal = null;
    
    Object.defineProperty(window, 'PROMPTS', {
        get: function() { return _promptsVal; },
        set: function(val) {
            _promptsVal = val;
            if (currentLoadingKey && val && val.system) {
                defaults[currentLoadingKey] = val.system;
            }
        },
        configurable: true
    });

    async function loadModulePrompt(mod) {
        if (!mod.source) {
            defaults[mod.key] = defaultHistoryPrompt; 
            return;
        }
        
        return new Promise((resolve) => {
            currentLoadingKey = mod.key;
            const script = document.createElement('script');
            script.src = mod.source;
            script.onload = () => {
                currentLoadingKey = null;
                resolve();
            };
            script.onerror = () => {
                console.warn(`Failed to load prompts for ${mod.key}`);
                defaults[mod.key] = "";
                currentLoadingKey = null;
                resolve();
            };
            document.body.appendChild(script);
        });
    }

    async function init() {
      await MM.ready;
      // Load sequentially to avoid race conditions on window.PROMPTS
      for (const mod of modules) {
        await loadModulePrompt(mod);
      }
      renderModuleList();
      renderEditor();
    }

    // --- Stars ---
    const canvas = document.getElementById('stars-canvas');
    const ctx = canvas.getContext('2d');
    let width, height, stars=[];
    function resize(){ width=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; initStars(); }
    function initStars(){ stars.length=0; for(let i=0;i<width*height/6000;i++) stars.push({x:Math.random()*width, y:Math.random()*height, r:Math.random()*1.5, a:Math.random(), s:0.01+Math.random()*0.02}); }
    function drawStars(){ ctx.clearRect(0,0,width,height); ctx.fillStyle="#fff"; stars.forEach(s=>{ s.a+=s.s; if(s.a>1||s.a<0)s.s=-s.s; ctx.globalAlpha=Math.abs(s.a); ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); }); requestAnimationFrame(drawStars); }
    window.addEventListener('resize',resize); resize(); drawStars();

    init();
  </script>
</body>
</html>
