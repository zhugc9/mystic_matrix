<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>赛博易经 · 灵筮</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  
  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  
  <script src="../common/storage.js"></script>
  <script src="../common/app.js"></script>
  <script src="../common/immersive.js"></script>
  <script src="./prompts.js"></script>

  <style>
    /* Astro Design System Alignment */
    :root {
      --bg-dark: #050510;
      --accent-gold: #d4af37;
      --accent-glow: rgba(212, 175, 55, 0.6);
      --glass-bg: rgba(16, 20, 43, 0.85);
      --text-main: #eee;
    }

    body, html {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background-color: var(--bg-dark);
      color: var(--text-main);
      font-family: 'Cinzel', -apple-system, sans-serif;
      overflow: hidden;
      user-select: none;
    }

    #stars-canvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.6; pointer-events:none;
    }

    /* Standard Header */
    .topbar {
        height: 80px;
        display: flex; align-items: center; justify-content: center;
        position: relative; z-index: 100;
        margin-bottom: 20px;
    }
    .title {
        color: var(--accent-gold); font-size: 2.2rem; margin: 0;
        font-family: 'Cinzel', serif; letter-spacing: 4px;
        text-shadow: 0 0 10px rgba(212,175,55,0.5);
    }
    .subtitle {
        color: rgba(255,255,255,0.6); text-align: center; font-size: 0.8rem; letter-spacing: 2px;
        position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
    }
    .nav-btn {
        position: absolute; top: 30px; left: 30px;
        color: rgba(255,255,255,0.6); text-decoration: none; text-transform: uppercase;
        letter-spacing: 1px; transition: 0.3s;
    }
    .nav-btn:hover { color: var(--accent-gold); text-shadow: 0 0 8px var(--accent-glow); }

    /* Container & Cards */
    #game-stage {
      position: relative; width: 100%; height: calc(100vh - 80px); z-index: 10;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    
    .glass-card {
        background: var(--glass-bg);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 8px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 30px rgba(0,0,0,0.4);
        padding: 40px;
        display: flex; flex-direction: column; align-items: center;
        max-width: 600px; width: 90%;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }

    /* Buttons */
    .btn {
        background: rgba(0,0,0,0.6);
        border: 1px solid var(--accent-gold);
        color: var(--accent-gold);
        padding: 10px 30px;
        border-radius: 30px;
        font-size: 1rem; letter-spacing: 2px; text-transform: uppercase;
        cursor: pointer; transition: all 0.3s;
        margin-top: 20px;
    }
    .btn:hover:not(:disabled) {
        background: var(--accent-gold); color: #000;
        box-shadow: 0 0 15px rgba(212,175,55,0.4);
    }

    /* Input Styles */
    .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-top:20px; }
    .input-group label { display: block; color: var(--accent-gold); margin-bottom: 5px; font-size: 0.8rem; }
    input, select, textarea {
        width: 100%; background: rgba(0,0,0,0.4);
        border: 1px solid rgba(255,255,255,0.2);
        color: #fff; padding: 8px; border-radius: 6px;
        font-family: monospace; font-size: 0.95rem; outline: none;
        box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent-gold); }
    .full-width { grid-column: span 2; }

    /* Ritual UI */
    #cam-video {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      object-fit: cover; z-index: -1; opacity: 0.3; /* Subtle camera */
      transform: scaleX(-1);
    }
    #cam-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; transform: scaleX(-1);
    }

    .ritual-container {
        position: relative; z-index: 5; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 100%; width: 100%;
    }

    .hex-board { display: flex; flex-direction: column-reverse; gap: 8px; margin-bottom: 30px; }
    .yao-line {
      width: 240px; height: 32px; background: rgba(0,0,0,0.6);
      border: 1px solid rgba(212,175,55,0.2); border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.5s;
    }
    .yao-line.active { border-color: var(--accent-gold); box-shadow: 0 0 10px rgba(212,175,55,0.3); }
    .yao-bar { width: 160px; height: 10px; display: flex; justify-content: space-between; position:relative; }
    .bar-yang { width: 100%; height: 100%; background: var(--accent-gold); box-shadow: 0 0 5px var(--accent-gold); border-radius:2px; }
    .bar-yin { width: 42%; height: 100%; background: var(--accent-gold); box-shadow: 0 0 5px var(--accent-gold); border-radius:2px; }
    .bar-moving { position: absolute; right: -25px; top: -2px; color: #fff; font-size: 10px; opacity: 0.7; }

    .status-hud {
        background: rgba(0,0,0,0.6); border: 1px solid rgba(212,175,55,0.3);
        padding: 10px 30px; border-radius: 40px;
        display: flex; flex-direction: column; align-items: center; gap: 5px;
        backdrop-filter: blur(5px); margin-bottom: 20px;
        min-width: 200px;
    }
    .status-icon { font-size: 2rem; margin-bottom: 5px; }
    .status-text { font-size: 1.1rem; color: #fff; letter-spacing: 2px; }
    .status-sub { font-size: 0.8rem; color: #aaa; }

    /* Coins */
    .coins-display { display: flex; gap: 30px; margin-bottom: 30px; perspective: 1000px; height: 80px; }
    .coin {
      width: 70px; height: 70px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      display: flex; align-items: center; justify-content: center;
      font-size: 2rem; font-weight: bold; color: #4b3600;
      transform-style: preserve-3d;
      position: relative;
    }
    .coin::before {
        content: ''; position: absolute; inset: 4px; border: 2px dashed rgba(75, 54, 0, 0.3); border-radius: 50%;
    }
    .coin.heads::after { content: "字"; }
    .coin.tails::after { content: "背"; }

    /* Result Scroll */
    .result-limit {
        width: 100%; height: 100%; overflow-y: auto; padding: 20px;
        background: transparent; color: #ddd; line-height: 1.6;
    }
    .result-limit h1, .result-limit h2 { color: var(--accent-gold); border-bottom: 1px solid rgba(212,175,55,0.2); }

    /* Typography & Animations (Tarot Style) */
    .title {
        color: var(--accent-gold);
        font-family: 'Cinzel', serif;
        font-size: clamp(2rem, 5vw, 3.5rem); /* Responsive sizing like Tarot */
        text-shadow: 0 0 15px rgba(212, 175, 55, 0.5), 0 0 30px rgba(212, 175, 55, 0.3);
        letter-spacing: 0.2em; /* Wider spacing */
        margin: 0;
        text-transform: uppercase;
        animation: titleGlow 3s ease-in-out infinite alternate;
    }
    
    .subtitle {
        color: rgba(255, 255, 255, 0.8);
        font-family: 'Cinzel', serif;
        font-size: clamp(0.9rem, 1.5vw, 1.2rem);
        letter-spacing: 0.3em;
        margin-top: 10px;
        opacity: 0.8;
        text-transform: uppercase;
    }

    /* Animations */
    @keyframes titleGlow {
        0% { text-shadow: 0 0 15px rgba(212, 175, 55, 0.5); }
        100% { text-shadow: 0 0 30px rgba(212, 175, 55, 0.8), 0 0 50px rgba(212, 175, 55, 0.4); }
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toss { 
       0% { transform: translateY(0) rotateX(0); }
       50% { transform: translateY(-150px) rotateX(720deg) scale(1.1); }
       100% { transform: translateY(0) rotateX(1440deg) scale(1); }
    }
    .tossing { animation: toss 0.6s ease-out; }
    
    /* Global Text Classes */
    .fade-in-text { animation: fadeIn 1.5s ease-out forwards; }
  </style>
</head>
<body>

  <canvas id="stars-canvas"></canvas>

  <header class="topbar" id="nav-header" style="display:none;">
    <a href="../index.html" class="nav-btn">← 返回大厅</a>
    <div>
        <h1 class="title">灵筮</h1>
        <div class="subtitle">CYBER I-CHING</div>
    </div>
  </header>

  <div id="game-stage">
    
    <!-- Intro -->
    <div id="stage-intro" class="glass-card" style="text-align:center;">
       <h1 style="color:var(--accent-gold); font-family:'Cinzel'; font-size:3rem; margin-bottom:10px; text-shadow:0 0 20px var(--accent-glow);">灵筮</h1>
       <div style="color:var(--accent-gold); font-size:1.2rem; letter-spacing:4px; margin-bottom:30px; opacity:0.8;">CYBER I-CHING</div>
       <p style="color:#aaa; line-height:1.6; margin-bottom:30px; font-size:0.9rem;">
           手势感应 · 六爻排盘 · AI解卦<br>
           Use gestures to cast hexagrams.
       </p>
       <button class="btn" onclick="Game.toIntention()">开启卜筮</button>
    </div>

    <!-- Intention -->
    <div id="stage-intention" class="glass-card" style="display:none; align-items:stretch;">
      <h2 style="color:var(--accent-gold); text-align:center; margin-top:0;">诚意正心</h2>
      <div class="input-grid">
        <div class="input-group">
          <label>性别</label>
          <select id="inp-gender"><option value="male">男</option><option value="female">女</option></select>
        </div>
        <div class="input-group">
            <label>出生地</label>
            <input id="inp-location" placeholder="例如: 北京">
        </div>
        
        <!-- Bazi -->
        <div class="input-group"><label>年</label><input id="year" type="number" value="1995"></div>
        <div class="input-group"><label>月</label><input id="month" type="number" value="1"></div>
        <div class="input-group"><label>日</label><input id="day" type="number" value="1"></div>
        <div class="input-group"><label>时</label><input id="hour" type="number" value="12"></div>
        
        <div class="input-group full-width">
          <label>所求之事</label>
          <textarea id="inp-question" rows="3" placeholder="心中默念所求..."></textarea>
        </div>
      </div>
      <div style="text-align:center;">
          <button class="btn" onclick="Game.toRitual()">进入仪式</button>
      </div>
    </div>

    <!-- Ritual -->
    <div id="stage-ritual" style="display:none; width:100%; height:100%;">
      <video id="cam-video" playsinline muted></video>
      <canvas id="cam-overlay"></canvas>
      
      <div class="ritual-container">
        
        <!-- Hexagram Display -->
        <div class="hex-board" id="hex-board"></div>

        <!-- Coins -->
        <div class="coins-display">
           <div id="c1" class="coin"></div><div id="c2" class="coin"></div><div id="c3" class="coin"></div>
        </div>

        <!-- HUD -->
        <div class="status-hud">
            <div class="status-icon" id="ring-icon">✊</div>
            <div class="status-text" id="ritual-hint">请握拳聚气...</div>
            <div class="status-sub" id="gesture-feedback">检测中...</div>
        </div>
        
        <button id="manual-btn" class="btn" style="background:rgba(0,0,0,0.3); border-color:#888; color:#aaa; font-size:0.8rem; padding:6px 20px; margin-top:10px;" onclick="Game.manualAction()">
            手动执行
        </button>
      </div>
    </div>

    <!-- Result -->
    <div id="stage-result" class="glass-card" style="display:none; width:90%; height:90%; padding:0;">
      <div style="padding:20px; border-bottom:1px solid rgba(212,175,55,0.2); width:100%; box-sizing:border-box; display:flex; justify-content:space-between; align-items:center;">
          <h2 style="margin:0; color:var(--accent-gold);">卦象解读</h2>
          <button class="btn" style="margin:0; padding:6px 20px; font-size:0.8rem;" onclick="location.href='../index.html'">完成</button>
      </div>
      <div class="result-limit">
          <div id="result-content"></div>
      </div>
    </div>

  </div>

  <script>
    // --- Stars ---
    const canvas = document.getElementById('stars-canvas');
    const ctx = canvas.getContext('2d');
    let width, height, stars=[];
    function resize(){ width=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; initStars(); }
    function initStars(){ stars.length=0; for(let i=0;i<width*height/6000;i++) stars.push({x:Math.random()*width, y:Math.random()*height, r:Math.random()*1.5, a:Math.random(), s:0.01+Math.random()*0.02}); }
    function drawStars(){ ctx.clearRect(0,0,width,height); ctx.fillStyle="#fff"; stars.forEach(s=>{ s.a+=s.s; if(s.a>1||s.a<0)s.s=-s.s; ctx.globalAlpha=Math.abs(s.a); ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); }); requestAnimationFrame(drawStars); }
    window.addEventListener('resize',resize); resize(); drawStars();

    // --- Game Logic ---
    const Game = {
        state: { userData:{}, lines:[], step:0, cooldown:0, isProcessing:false },
        action: { mode:'charge', progress:0, lastFrame:0 },
        camera: null, handDetector: null,

        init: async function() { await MM.ready; this.switchStage('intro'); },
        switchStage: function(id) { 
            document.querySelectorAll('#game-stage > div').forEach(e=>e.style.display='none'); 
            const stage = document.getElementById('stage-'+id);
            stage.style.display = (id==='ritual') ? 'block' : 'flex'; 
            
            const nav = document.getElementById('nav-header');
            if(nav) nav.style.display = (id==='intro') ? 'none' : 'flex';
        },
        
        toIntention: function() { this.switchStage('intention'); },
        
        toRitual: async function() {
             this.state.userData = {
                 gender:MM.$('inp-gender').value,
                 bazi:{y:MM.$('year').value, m:MM.$('month').value, d:MM.$('day').value, h:MM.$('hour').value},
                 loc:MM.$('inp-location').value,
                 question:MM.$('inp-question').value
             };
             this.state.lines=[]; this.state.step=0; this.resetAction('charge');
             this.initHexBoard();
             this.switchStage('ritual');
             await this.startCamera();
        },

        initHexBoard: function() {
            const b = document.getElementById('hex-board'); b.innerHTML='';
            for(let i=0; i<6; i++) {
                const d = document.createElement('div');
                d.className='yao-line'; d.id=`line-${i}`;
                b.appendChild(d);
            }
        },

        startCamera: async function() {
             if(this.camera) return;
             const v = document.getElementById('cam-video');
             const o = document.getElementById('cam-overlay');
             const c = o.getContext('2d');
             
             this.handDetector = new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
             this.handDetector.setOptions({
                 maxNumHands:1, 
                 modelComplexity:1, 
                 minDetectionConfidence:0.5, 
                 minTrackingConfidence:0.5
             });
             this.handDetector.onResults(res=>{
                 o.width=v.videoWidth; o.height=v.videoHeight; c.clearRect(0,0,o.width,o.height);
                 if(res.multiHandLandmarks && res.multiHandLandmarks.length) {
                     const lm = res.multiHandLandmarks[0];
                     // SKELETON: Standard Visuals (Requested Revert)
                     drawConnectors(c, lm, HAND_CONNECTIONS, {color:'#d4af37', lineWidth:1});
                     drawLandmarks(c, lm, {color:'#fff', radius:2});
                     this.processHand(lm);
                 } else { this.resetProgress(); }
             });
             this.camera = new Camera(v, {
                 onFrame:async()=>{await this.handDetector.send({image:v})}, 
                 width:640, 
                 height:480
             });
             await this.camera.start();
        },

        countExtendedFingers: function(lm) {
            let count = 0;
            const wrist = lm[0];
            const palmWidth = Math.hypot(lm[5].x - lm[17].x, lm[5].y - lm[17].y);
            
            // Thumb
            const thumbTip = lm[4];
            const indexBase = lm[5];
            const thumbDist = Math.hypot(thumbTip.x - indexBase.x, thumbTip.y - indexBase.y);
            if (thumbDist > palmWidth * 0.5) count++; 

            // Fingers
            const tips = [8,12,16,20];
            const pips = [6,10,14,18];
            tips.forEach((tipIdx, i) => {
                const pipIdx = pips[i];
                const dTip = Math.hypot(lm[tipIdx].x - wrist.x, lm[tipIdx].y - wrist.y);
                const dPip = Math.hypot(lm[pipIdx].x - wrist.x, lm[pipIdx].y - wrist.y);
                if (dTip > dPip) count++;
            });
            return count;
        },

        isFist: function(lm) { const c = this.countExtendedFingers(lm); return c <= 1; },
        isOpen: function(lm) { const c = this.countExtendedFingers(lm); return c >= 4; },

        processHand: function(lm) {
            if(this.state.isProcessing || Date.now() < this.state.cooldown) return;
            const now = Date.now();
            const delta = now - (this.action.lastFrame||now); 
            this.action.lastFrame=now;

            let hit = false;
            const fingerCount = this.countExtendedFingers(lm);
            
            // Update UI feedback (Pretty)
            const feedbackEl = document.getElementById('gesture-feedback');
            if(feedbackEl) {
                let text = "调整中...";
                let color = "#aaa";
                if(fingerCount <= 1) { text = "检测到: 握拳"; color = "#4f4"; }
                else if(fingerCount >= 4) { text = "检测到: 张手"; color = "#4f4"; }
                feedbackEl.innerText = text;
                feedbackEl.style.color = color;
            }

            if(this.action.mode==='charge' && fingerCount <= 1) hit=true;
            if(this.action.mode==='cast' && fingerCount >= 4) hit=true;
            if(this.action.mode==='finish' && fingerCount <= 1) hit=true; // Fist to confirm

            if(hit) {
                this.action.progress += delta/1500;
                if(this.action.progress>=1) { 
                    this.action.progress=1; 
                    this.nextPhase(); 
                }
            } else {
                this.action.progress = Math.max(0, this.action.progress - 0.05);
            }
            // Simple visual scaler
            const scale = 1 + this.action.progress * 0.3;
            document.getElementById('ring-icon').style.transform = `scale(${scale})`;
        },

        resetProgress: function() { 
            this.action.progress=Math.max(0, this.action.progress-0.05); 
            document.getElementById('ring-icon').style.transform = `scale(1)`;
        },

        resetAction: function(m) {
            this.action.mode=m; this.action.progress=0; 
            document.getElementById('ring-icon').style.transform = `scale(1)`;
            
            const h = document.getElementById('ritual-hint');
            const i = document.getElementById('ring-icon');
            const btn = document.getElementById('manual-btn');
            
            if(m==='charge') { 
                h.textContent=`第 ${this.state.step+1} 爻：握拳聚气`; i.textContent="✊"; 
                if(btn) btn.textContent = "手动聚气";
            }
            else if(m==='cast') { 
                h.textContent="张手抛币"; i.textContent="🖐"; 
                if(btn) btn.textContent = "手动抛掷";
            }
            else if(m==='wait') { 
                h.textContent="演化中..."; i.textContent="⏳"; 
                if(btn) btn.textContent = "...";
            }
            else if(m==='finish') { 
                h.textContent="六爻已成，握拳确认"; i.textContent="✊"; 
                if(btn) btn.textContent = "确认卦象";
            }
        },

        nextPhase: async function() {
            this.state.cooldown = Date.now()+1000;
            if(this.action.mode==='charge') this.resetAction('cast');
            else if(this.action.mode==='cast') { this.resetAction('wait'); await this.castCoins(); }
            else if(this.action.mode==='finish') this.analyze();
        },

        castCoins: async function() {
            this.state.isProcessing = true;
            const vals = [0,0,0].map(()=>Math.random()>0.5?2:3); // 2=Back, 3=Face
            
            // Standard Animation (CSS Class Swap)
            [1,2,3].forEach((id,i) => {
                const el = document.getElementById('c'+id);
                el.className = 'coin tossing';
                setTimeout(() => {
                    el.className = `coin ${vals[i]===3?'heads':'tails'}`;
                }, 600);
            });
            await new Promise(r=>setTimeout(r,800));

            // Logic
            const sum = vals.reduce((a,b)=>a+b, 0);
            const isYang = (sum===7||sum===9);
            const isMoving = (sum===6||sum===9);
            this.state.lines.push({sum});

            // Render
            const row = document.getElementById(`line-${this.state.step}`);
            row.classList.add('active');
            
            const bar = document.createElement('div');
            bar.className = 'yao-bar';
            
            const movingHTML = isMoving ? `<span class="bar-moving">●</span>` : '';
            if(isYang) bar.innerHTML = `<div class="bar-yang"></div>${movingHTML}`;
            else bar.innerHTML = `<div class="bar-yin"></div><div class="bar-yin"></div>${movingHTML}`;
            
            row.innerHTML = ''; row.appendChild(bar);

            this.state.step++;
            this.state.isProcessing = false;
            
            if(this.state.step>=6) this.resetAction('finish');
            else this.resetAction('charge');
        },

        manualAction: function() {
            if(this.state.isProcessing) return;
            if(this.action.mode === 'charge') this.nextPhase();
            else if(this.action.mode === 'cast') this.nextPhase();
            else if(this.action.mode === 'finish') this.nextPhase();
        },

        analyze: async function() {
            this.switchStage('result');
            if(this.camera) { this.camera.stop(); this.camera=null; }
            const promptData = { 
                bazi:this.state.userData.bazi, 
                question:this.state.userData.question, 
                lines:this.state.lines.map(l=>l.sum) 
            };
            
            const sys = window.PROMPTS.system;
            const user = window.PROMPTS.generateUserPrompt(promptData.bazi, { benGua:{name:'(待解)'}, bianGua:{name:'(待解)'}, changingLines:[], coinRecords:[] }, promptData.question, "", this.state.userData);
            
            try {
                const text = await MM.chat({ system:sys, user:user });
                const con = document.getElementById('result-content');
                MM.renderMarkdown(con, text);
                MM.saveRecord({
                    type:'iching', summary:`[易经] ${this.state.userData.question}`, fullContent:text, meta:promptData
                });
            } catch(e) {
                document.getElementById('result-content').innerHTML = `<p style="color:red">Error: ${e.message}</p>`;
            }
        }
    };
  </script>
</body>
</html>
