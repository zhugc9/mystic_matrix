<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>星盘实验室</title>
  <link rel="stylesheet" href="../common/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js" crossorigin="anonymous"></script>
  <script src="../common/storage.js"></script>
  <script src="../common/app.js"></script>
  <script src="../common/immersive.js"></script>
  <script src="./prompts.js"></script>
  <style>
    /* Inherit/Override for consistency */
    body {
        background-color: #050510;
        color: #eee;
        overflow-x: hidden;
    }
    
    #stars-canvas {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1; opacity: 0.6;
      pointer-events: none;
    }

    .profile-card {
      max-height: none;
      overflow: visible;
      transition: none;
      background: rgba(16, 20, 43, 0.85); /* Darker, more glass */
      border: 1px solid rgba(212, 175, 55, 0.3);
      backdrop-filter: blur(10px);
    }
    
    .btn {
        background: rgba(0,0,0,0.6);
        border: 1px solid #d4af37;
        color: #d4af37;
        border-radius: 30px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .btn:hover:not(:disabled) {
        background: #d4af37;
        color: #000;
    }

    .profile-head {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
    }

    .chart-wrap {
      max-width: 460px;
      min-height: 240px;
      margin: 10px auto 0;
      position: relative;
    }

    .scene-stage {
      opacity: 0;
      transform: translateY(12px);
      max-height: 0;
      overflow: hidden;
      pointer-events: none;
      transition: opacity 0.36s ease, transform 0.36s ease, max-height 0.36s ease;
    }

    .scene-stage.active {
      opacity: 1;
      transform: translateY(0);
      max-height: 2400px; /* Arbitrary large */
      overflow: visible;
      pointer-events: auto;
    }
    
    /* Input Styling override */
    input, select, textarea {
        background: rgba(0,0,0,0.4) !important;
        border: 1px solid rgba(255,255,255,0.2) !important;
        color: #fff !important;
        border-radius: 6px !important;
    }
  </style>
</head>
<body>
  
  <canvas id="stars-canvas"></canvas>

  <header class="topbar" style="background:transparent; border:none; text-align:center;">
    <div>
      <h1 class="title" style="color:#d4af37; font-size:2.5rem; letter-spacing:4px; text-shadow:0 0 10px rgba(212,175,55,0.5);">星盘实验室</h1>
      <p class="subtitle" style="color:rgba(255,255,255,0.6);">STABLE STAR CHART COMPUTE</p>
    </div>
  </header>

  <main class="container">
    <section class="card profile-card scene-stage active" id="profile-panel" data-step="1">
      <div class="profile-head">
        <h2 style="margin:0; color:#d4af37;">第一幕 · 立意</h2>
      </div>
      <div class="grid cols-3">
        <div>
          <label for="mode">分析模式</label>
          <select id="mode">
            <option value="natal">本命盘</option>
            <option value="synastry">关系盘</option>
          </select>
        </div>
        <!-- Name Removed -->
        <div>
          <label for="user-gender">性别</label>
          <select id="user-gender">
            <option value="">保密</option>
            <option value="男">男</option>
            <option value="女">女</option>
          </select>
        </div>
        <div>
          <label for="user-birth">出生日期（可选）</label>
          <input id="user-birth" type="date" />
        </div>
        <div>
          <label for="user-location">出生地/常驻地</label>
          <input id="user-location" placeholder="例如：广州" />
        </div>
        <div style="grid-column: span 2;">
          <label for="extra">来意补述（可选）</label>
          <input id="extra" placeholder="例如：想重点看今年事业与关系的取舍方向。" />
        </div>
      </div>
      <div id="status" class="status"></div>
    </section>

    <section class="card profile-card scene-stage active" id="natal-box" data-step="1">
      <div class="profile-head">
        <h2 style="margin:0; color:#d4af37;">本命盘参数</h2>
      </div>
      <div class="grid cols-3">
        <div>
          <label for="n-date">出生日期</label>
          <input id="n-date" type="date" value="1995-08-15" />
        </div>
        <div>
          <label for="n-time">出生时间</label>
          <input id="n-time" type="time" value="14:00" />
        </div>
        <div>
          <label for="n-location">出生地点</label>
          <input id="n-location" value="北京" />
        </div>
      </div>
    </section>

    <section class="card hidden profile-card scene-stage active" id="syn-box" data-step="1">
      <div class="profile-head">
        <h2 style="margin:0; color:#d4af37;">关系盘参数</h2>
      </div>
      <div class="grid cols-3">
        <div>
          <label for="p1-date">甲方日期</label>
          <input id="p1-date" type="date" value="1995-08-15" />
        </div>
        <div>
          <label for="p1-time">甲方时间</label>
          <input id="p1-time" type="time" value="14:00" />
        </div>
        <div>
          <label for="p1-location">甲方地点</label>
          <input id="p1-location" value="北京" />
        </div>
        <div>
          <label for="p2-date">乙方日期</label>
          <input id="p2-date" type="date" value="1998-01-06" />
        </div>
        <div>
          <label for="p2-time">乙方时间</label>
          <input id="p2-time" type="time" value="09:20" />
        </div>
        <div>
          <label for="p2-location">乙方地点</label>
          <input id="p2-location" value="上海" />
        </div>
      </div>
    </section>

    <section class="card scene-stage active" data-step="2">
      <h2 style="color:#d4af37;">第二幕 · 构建星盘</h2>
      <div class="chart-wrap">
        <canvas id="astro-chart" class="astro-canvas"></canvas>
      </div>
      <div class="controls" style="text-align: center; margin-top:20px;">
        <button class="btn primary" id="run" disabled>开始分析</button>
      </div>
      <div class="status" id="chart-status" style="text-align:center; color:#aaa; margin-top:10px;"></div>
      <div class="analysis-progress-wrap">
        <div class="analysis-progress-bar" id="analysis-progress"></div>
      </div>
    </section>

    <section class="card scene-stage" data-step="3" style="display:none;"> <!-- Hidden, used for logic -->
      <textarea id="systemPrompt"></textarea>
    </section>

    <section class="card scene-stage" data-step="4">
      <h2 style="color:#d4af37;">第三幕 · 神谕降临</h2>
      <div id="result" class="result" style="color:#ddd; line-height:1.6;"></div>
      <div class="result-actions">
        <button class="btn" id="again">再来一次</button>
        <a class="btn" style="margin-left: 10px; text-decoration:none;" href="../index.html">返回大厅</a>
      </div>
    </section>
  </main>

  <script>
    // --- Starry Background ---
    const canvas = document.getElementById('stars-canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    const stars = [];
    function resize() { width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height; initStars(); }
    function initStars() { stars.length=0; for(let i=0;i<Math.floor(width*height/4000);i++) stars.push({x:Math.random()*width,y:Math.random()*height,r:Math.random()*1.5,a:Math.random(),s:Math.random()*0.02+0.005}); }
    function drawStars() { ctx.clearRect(0,0,width,height); ctx.fillStyle="#fff"; stars.forEach(s=>{s.a+=s.s;if(s.a>1||s.a<0)s.s=-s.s;ctx.globalAlpha=Math.abs(s.a);ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();}); requestAnimationFrame(drawStars); }
    window.addEventListener('resize', resize); resize(); drawStars();


    const TYPE = "astro";
    const statusEl = MM.$("status");
    const chartStatusEl = MM.$("chart-status");
    const systemEl = MM.$("systemPrompt");
    const resultEl = MM.$("result");
    const runBtn = MM.$("run");
    const analysisProgressEl = MM.$("analysis-progress");

    const planetDefs = [
      { body: "Sun", name: "日", color: "#f5cd75" },
      { body: "Moon", name: "月", color: "#f3f1ff" },
      { body: "Mercury", name: "水", color: "#98c8ff" },
      { body: "Venus", name: "金", color: "#ffd6b4" },
      { body: "Mars", name: "火", color: "#ff8a8a" },
      { body: "Jupiter", name: "木", color: "#f6b86f" },
      { body: "Saturn", name: "土", color: "#d6c290" },
      { body: "Uranus", name: "天", color: "#7fd4e8" },
      { body: "Neptune", name: "海", color: "#7e8dff" },
      { body: "Pluto", name: "冥", color: "#c995ff" }
    ];

    const zodiacNames = ["白羊", "金牛", "双子", "巨蟹", "狮子", "处女", "天秤", "天蝎", "射手", "摩羯", "水瓶", "双鱼"];

    const chartState = {
      p1: [],
      p2: [],
      mode: "natal"
    };
    
    // Animation State
    let rotation = 0;

    const fallbackOrbitDefs = {
      Sun: { l0: 280.46646, n: 0.98564736 },
      Moon: { l0: 218.316, n: 13.176396 },
      Mercury: { l0: 252.251, n: 4.09233445 },
      Venus: { l0: 181.979, n: 1.60213034 },
      Mars: { l0: 355.433, n: 0.524039 },
      Jupiter: { l0: 34.351, n: 0.0830867 },
      Saturn: { l0: 50.077, n: 0.0334597 },
      Uranus: { l0: 314.055, n: 0.01173129 },
      Neptune: { l0: 304.348, n: 0.00598103 },
      Pluto: { l0: 238.929, n: 0.003964 }
    };

    let chartGenerated = false;
    let isRunning = false;
    let progressTimer = null;
    let storyStep = 2;
    let chartAutoTimer = null;

    function makeLocalDate(dateStr, timeStr) {
      if (!dateStr) return new Date();
      const [y, m, d] = dateStr.split("-").map(Number);
      const [hh, mm] = (timeStr || "00:00").split(":").map(Number);
      return new Date(y, (m || 1) - 1, d || 1, hh || 0, mm || 0, 0, 0);
    }

    function normDeg(v) {
      const n = v % 360;
      return n < 0 ? n + 360 : n;
    }

    function daysSinceJ2000(dateObj) {
      const j2000 = Date.UTC(2000, 0, 1, 12, 0, 0, 0);
      return (dateObj.getTime() - j2000) / 86400000;
    }

    function calcLongitudes(dateObj) {
      const d = daysSinceJ2000(dateObj);
      return {
        points: planetDefs.map((item) => {
          const orbit = fallbackOrbitDefs[item.body];
          return {
            name: item.name,
            lon: normDeg(orbit.l0 + orbit.n * d),
            color: item.color
          };
        })
      };
    }

    function setupChartRenderer() {
      const canvas = MM.$("astro-chart");
      const ctx = canvas.getContext("2d");
      let w = 0, h = 0, cx = 0, cy = 0, radius = 0;

      function resizeChart() {
        const box = canvas.parentElement.getBoundingClientRect();
        w = canvas.width = Math.floor(box.width);
        h = canvas.height = Math.max(240, Math.floor(box.height));
        cx = w / 2;
        cy = h / 2;
        radius = Math.min(w, h) * 0.35;
      }

      function drawRing() {
        ctx.save();
        ctx.translate(cx, cy);
        
        // Rotating Outer Ring
        ctx.save();
        ctx.rotate(rotation * 0.0005); 
        
        ctx.strokeStyle = "rgba(212, 175, 55, 0.2)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0; i<36; i++) {
            ctx.moveTo(radius + 10, 0);
            ctx.lineTo(radius + 20, 0);
            ctx.rotate(Math.PI * 2 / 36);
        }
        ctx.stroke();
        ctx.restore();

        // Main Ring
        ctx.fillStyle = "rgba(11, 20, 45, 0.4)";
        ctx.beginPath();
        ctx.arc(0, 0, radius + 40, 0, Math.PI * 2);
        ctx.fill();

        // Zodiac Sectors
        for (let i = 0; i < 12; i += 1) {
          const start = (-90 + i * 30) * Math.PI / 180;
          const end = start + (30 * Math.PI / 180);
          ctx.beginPath();
          ctx.strokeStyle = "rgba(255, 255, 255, 0.05)";
          ctx.lineWidth = 1;
          ctx.arc(0, 0, radius, start, end);
          ctx.stroke();

          // Text
          const mid = start + (15 * Math.PI / 180);
          const tx = Math.cos(mid) * (radius + 24);
          const ty = Math.sin(mid) * (radius + 24);
          ctx.fillStyle = "rgba(212, 175, 55, 0.8)";
          ctx.font = "12px 'Cinzel', sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(zodiacNames[i], tx, ty);
          
          // Spokes
          const dx = Math.cos(start) * (radius - 10);
          const dy = Math.sin(start) * (radius - 10);
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.lineTo(dx, dy);
          ctx.strokeStyle = "rgba(255, 255, 255, 0.05)";
          ctx.stroke();
        }
        
        // Inner Circle
        ctx.beginPath();
        ctx.strokeStyle = "rgba(212, 175, 55, 0.5)";
        ctx.lineWidth = 2;
        ctx.arc(0, 0, radius, 0, Math.PI * 2);
        ctx.stroke();
        
        ctx.restore();
      }

      function drawPlanets(points, ringRadius, labelColor) {
        ctx.save();
        ctx.translate(cx, cy);
        points.forEach((p) => {
          const angle = ((p.lon - 90) * Math.PI) / 180;
          const x = Math.cos(angle) * ringRadius;
          const y = Math.sin(angle) * ringRadius;

          ctx.beginPath();
          ctx.fillStyle = p.color;
          ctx.shadowColor = p.color;
          ctx.shadowBlur = 10;
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();

          ctx.shadowBlur = 0;
          ctx.fillStyle = labelColor || p.color;
          ctx.font = "10px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(p.name, x * 1.15, y * 1.15); // Push text out
          
          // Line to center
          ctx.beginPath();
          ctx.moveTo(0,0);
          ctx.lineTo(x, y);
          ctx.strokeStyle = "rgba(255,255,255,0.05)";
          ctx.stroke();
        });
        ctx.restore();
      }

      function draw(now) {
        ctx.clearRect(0, 0, w, h);
        rotation += 1;

        drawRing();

        const pulse = 1 + Math.sin(now * 0.002) * 0.01;
        
        if (chartGenerated) {
           if (chartState.p1.length) drawPlanets(chartState.p1, radius * 0.9 * pulse, "#f5e9d0");
           if (chartState.mode === "synastry" && chartState.p2.length) {
             const p2 = chartState.p2.map((it) => ({ ...it, color: "#73c7ff" }));
             drawPlanets(p2, radius * 0.7 * pulse, "#bde7ff");
           }
        }

        requestAnimationFrame(draw);
      }

      window.addEventListener("resize", resizeChart);
      resizeChart();
      requestAnimationFrame(draw);
    }

    function toggleMode() {
      const mode = MM.$("mode").value;
      MM.$("natal-box").classList.toggle("hidden", mode !== "natal");
      MM.$("syn-box").classList.toggle("hidden", mode !== "synastry");
      chartState.mode = mode;
      chartGenerated = false;
      runBtn.disabled = true;
      chartStatusEl.textContent = "信息变更后会自动重建星盘";
      scheduleChartAutoBuild();
    }

    function setStoryStep(step) {
      storyStep = step;
      document.querySelectorAll(".scene-stage").forEach((el) => {
        const need = Number(el.dataset.step || "1");
        el.classList.toggle("active", need <= step);
      });
    }

    function startAnalyzeProgress() {
      stopAnalyzeProgress();
      let pct = 0;
      analysisProgressEl.style.width = "0%";
      progressTimer = setInterval(() => {
        pct = Math.min(92, pct + 2);
        analysisProgressEl.style.width = `${pct}%`;
      }, 130);
    }

    function stopAnalyzeProgress(done) {
      if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
      }
      analysisProgressEl.style.width = done ? "100%" : "0%";
      if (done) {
        setTimeout(() => {
          analysisProgressEl.style.width = "0%";
        }, 600);
      }
    }

    function generateRealChart() {
      const mode = MM.$("mode").value;
      chartState.mode = mode;
      const d1 = makeLocalDate(MM.$("n-date").value, MM.$("n-time").value);
      const p1Res = calcLongitudes(d1);
      chartState.p1 = p1Res.points;

      if (mode === "synastry") {
        const d2 = makeLocalDate(MM.$("p2-date").value, MM.$("p2-time").value);
        const p2Res = calcLongitudes(d2);
        chartState.p2 = p2Res.points;
      } else {
        chartState.p2 = [];
      }

      chartGenerated = chartState.p1.length > 0;
      runBtn.disabled = !chartGenerated;

      if (chartGenerated) {
        chartStatusEl.textContent = mode === "natal"
          ? "星盘已生成"
          : "合盘已生成";
        setStoryStep(2);
      }
    }

    function scheduleChartAutoBuild() {
      if (chartAutoTimer) clearTimeout(chartAutoTimer);
      chartAutoTimer = setTimeout(() => {
        generateRealChart();
      }, 220);
    }

    function again() {
      chartGenerated = false;
      runBtn.disabled = true;
      resultEl.innerHTML = "";
      setStoryStep(2);
      scheduleChartAutoBuild();
    }

    async function runAnalysis() {
      if (!chartGenerated) return;
      if (isRunning) return;
      isRunning = true;
      runBtn.disabled = true;

      try {
        if (window.MMImmersive) {
          await window.MMImmersive.showRitual({
            title: "星轨推演中",
            subtitle: "正在汇聚星体位置与提问意图",
            duration: 760
          });
        }
        startAnalyzeProgress();
        MM.status(statusEl, "正在生成解读...");

        const mode = MM.$("mode").value;
        const extra = MM.$("extra").value.trim();
        let userPrompt = "";
        
        // Name removed, use "命主" default in logic
        const name = "命主";
        const gender = MM.$("user-gender").value || "保密";
        const birth = MM.$("user-birth").value || "未填写";
        const location = MM.$("user-location").value.trim() || "未填写";

        if (mode === "natal") {
          const data = {
            date: MM.$("n-date").value,
            time: MM.$("n-time").value,
            location: MM.$("n-location").value.trim()
          };
          userPrompt = window.PROMPTS.generateNatalPrompt(data);
          userPrompt += `\n\n【基本信息】\n- 性别：${gender}\n- 出生日期：${birth}\n- 地区：${location}`;
        } else {
          const p1 = {
            date: MM.$("p1-date").value,
            time: MM.$("p1-time").value,
            location: MM.$("p1-location").value.trim()
          };
          const p2 = {
            date: MM.$("p2-date").value,
            time: MM.$("p2-time").value,
            location: MM.$("p2-location").value.trim()
          };
          userPrompt = window.PROMPTS.generateSynastryPrompt(p1, p2);
          userPrompt += `\n\n【基本信息】\n- 性别：${gender}`;
        }

        userPrompt += `\n\n来意补述：${extra || "无"}`;

        const content = await MM.chat({
          system: systemEl.value.trim(),
          user: userPrompt
        });

        MM.renderMarkdown(resultEl, content);
        setStoryStep(4);
        MM.saveRecord({
          type: TYPE,
          summary: MM.summarize(mode === "natal" ? "本命盘解读" : "关系盘解读", 50),
          fullContent: content,
          meta: { mode, chartP1: chartState.p1, chartP2: chartState.p2 }
        });

        MM.status(statusEl, "完成", "ok");
        stopAnalyzeProgress(true);
      } catch (err) {
        stopAnalyzeProgress(false);
        MM.status(statusEl, err.message, "error");
      } finally {
        isRunning = false;
        runBtn.disabled = !chartGenerated;
      }
    }

    MM.$("mode").addEventListener("change", toggleMode);
    MM.$("run").addEventListener("click", runAnalysis);
    MM.$("again").addEventListener("click", again);

    async function initPage() {
      await MM.ready;
      systemEl.value = MM.getPromptOverride(TYPE) || window.PROMPTS.system;
      setupChartRenderer();
      toggleMode();
      setStoryStep(storyStep);
      scheduleChartAutoBuild();
      
      const inputs = document.querySelectorAll('input, select');
      inputs.forEach(el => el.addEventListener('input', scheduleChartAutoBuild));
    }

    initPage();
  </script>
</body>
</html>
